# rules of firewall / правила для брендмауэра

You have to set the rules of your firewall on your server only with the services used outside the VM.

Вы должны установить правила брандмауэра на своем сервере только с сервисами, используемыми вне виртуальной машины.

------------------------------------------
Проверять порты открытые на сервере позволяет пакет `net-tools`. Установить его можно командой:

```bash
sudo -S apt-get install net-tools
```

Теперь с помощью команды `netstat` можно просмотреть открытые TCP-порты и TCP-сокеты, а так же узнать использующие их приложения и демоны. Например, открытые";
порты проверяются так:

```bash
netstat -nlp
```

или:

```bash
netstat -p
```

Вывести список TCP-соединений по портам, обслуживаемых нашим виртуальным сервером можно командой:

```bash
netstat -atn | grep "ESTABLISHED"
```

В ответ получим, что-то типа:

```
tcp        0     36 10.10.4.79:2002         10.10.5.6:22350         ESTABLISHED
```

Список всех TCP-портов, которые слушает наш сервер
можно командой:

```bash
netstat -atn | grep "LISTEN"
```

получим, что-то типа:
```
tcp        0      0 0.0.0.0:1080            0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:12345           0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:12346           0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:635             0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:49724           0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:540             0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:1               0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:20034           0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:32771           0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:32772           0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:40421           0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:32773           0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:32774           0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:31337           0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:6667            0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:11              0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:5742            0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:143             0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:79              0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:15              0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:54320           0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:2000            0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:27665           0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:2002            0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:1524            0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:119             0.0.0.0:*               LISTEN
tcp6       0      0 :::2002                 :::*                    LISTEN
```

На самом деле сдушает он в основном сеть lo (loopback). Но для надежности можно в явном виде закрыть все внешние порты с помощью пакета `iptables`. Все нужные команды собраны в скрипт [05-rules-of-firewall.sh](05-rules-of-firewall.sh). Читайте комментарии внутри. Исполнять скрипт нужна на сервере (виртуальной машине) с мз под SUDO.

Так же файрвол можно настроить и другими пакетами. Например: `nftables` (см.: https://blog.it-kb.ru/2019/07/25/debian-linux-10-buster-netfilter-firewall-basic-configuration-using-nftables/) или `iptables-persistent` -- позволяющие сделать различные правила для IPv4 и IPv6, или `ufw` -- еще один брандмауер с развесистой системой реакции на обращения по портам (см. http://blog.sedicomm.com/2018/07/06/kak-nastroit-brandmauer-ufw-na-ubuntu-i-debian/).  


